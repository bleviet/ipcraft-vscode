# Makefile for cocotb simulation with GHDL
# Generated by ipcore_lib VHDL Generator
#
# Usage:
#   make                    # Run all tests
#   make SIM=ghdl           # Explicitly use GHDL
#   make WAVES=1            # Generate waveforms (GHW format)
#   make TESTCASE=test_xyz  # Run specific test
#
# Prerequisites:
#   - GHDL (with mcode or LLVM backend)
#   - cocotb (pip install cocotb)
#   - cocotbext-axi (pip install cocotbext-axi) [for AXI verification]

# Simulator settings
SIM ?= ghdl
TOPLEVEL_LANG ?= vhdl

# VHDL source files (relative to tb/ directory)
RTL_DIR = $(CURDIR)/../rtl
VHDL_SOURCES += $(RTL_DIR)/{{ entity_name }}_pkg.vhd
VHDL_SOURCES += $(RTL_DIR)/{{ entity_name }}_regs.vhd
VHDL_SOURCES += $(RTL_DIR)/{{ entity_name }}_core.vhd
{% if bus_type == 'axil' %}
VHDL_SOURCES += $(RTL_DIR)/{{ entity_name }}_{{ bus_type }}.vhd
{% else %}
VHDL_SOURCES += $(RTL_DIR)/{{ entity_name }}_avmm.vhd
{% endif %}
VHDL_SOURCES += $(RTL_DIR)/{{ entity_name }}.vhd

# Top-level module
TOPLEVEL = {{ entity_name }}

# Test module (Python file without .py extension)
MODULE = {{ entity_name }}_test

# GHDL-specific options
ifeq ($(SIM),ghdl)
    # Use VHDL-2008 standard
    COMPILE_ARGS += --std=08

    # Relaxed rules for better compatibility
    COMPILE_ARGS += -frelaxed

    # Generate waveforms if WAVES=1
    ifeq ($(WAVES),1)
        SIM_ARGS += --wave={{ entity_name }}.ghw
    endif

    # Additional elaboration options
    SIM_BUILD = sim_build

    # Pass compile args to GHDL executable (before unit name)
    GHDL_ARGS += $(COMPILE_ARGS)
endif

# Cocotb settings
export COCOTB_REDUCED_LOG_FMT=1

# Add ipcore_lib to Python path (go up to workspace root: tb -> led -> examples -> ipcore_spec -> ipcore_lib)
export PYTHONPATH := $(shell cd $(CURDIR)/../../../.. && pwd):$(PYTHONPATH)

# Default target
include $(shell cocotb-config --makefiles)/Makefile.sim

# Additional targets
.PHONY: clean_all view_waves lint

clean_all: clean
	rm -rf sim_build __pycache__ results.xml *.ghw *.vcd

view_waves:
	gtkwave {{ entity_name }}.ghw &

lint:
	@echo "Checking VHDL syntax..."
	@for f in $(VHDL_SOURCES); do \
		echo "  $$f"; \
		ghdl -a --std=08 $$f || exit 1; \
	done
	@echo "All files OK"

# Help target
help:
	@echo "cocotb Testbench for {{ entity_name }}"
	@echo ""
	@echo "Targets:"
	@echo "  make            - Run all tests"
	@echo "  make WAVES=1    - Run tests and generate waveforms"
	@echo "  make view_waves - Open waveforms in GTKWave"
	@echo "  make lint       - Check VHDL syntax"
	@echo "  make clean      - Remove simulation build files"
	@echo "  make clean_all  - Remove all generated files"
	@echo ""
	@echo "Options:"
	@echo "  SIM=ghdl|modelsim|questa  - Simulator (default: ghdl)"
	@echo "  WAVES=1                   - Generate waveform file"
	@echo "  TESTCASE=test_name        - Run specific test"
	@echo "  COCOTB_LOG_LEVEL=DEBUG    - Verbose logging"
