# {{ entity_name }}_hw.tcl - Intel Platform Designer Component Definition
# Generated by ipcore_lib VHDL Generator
#
# Provides component integration for Intel Quartus Platform Designer (Qsys)
# with Avalon-MM slave interface for register access.
#
# Usage: Place this file in the same directory as your VHDL files and
# add the directory to Platform Designer's IP search path.

# -----------------------------------------------------------------------------
# Package Definition
# -----------------------------------------------------------------------------
package require qsys

# -----------------------------------------------------------------------------
# Validation Callback
# -----------------------------------------------------------------------------
proc validate {} {
# Add parameter validation here if needed
}

# -----------------------------------------------------------------------------
# Elaboration Callback
# -----------------------------------------------------------------------------
proc elaborate {} {
# -----------------------------------------------------------------------------
# Clock Interface
# -----------------------------------------------------------------------------
add_interface clk clock end
set_interface_property clk clockRate 0
set_interface_property clk ENABLED true
set_interface_property clk EXPORT_OF ""
set_interface_property clk PORT_NAME_MAP ""
set_interface_property clk CMSIS_SVD_VARIABLES ""
set_interface_property clk SVD_ADDRESS_GROUP ""

add_interface_port clk clk clk Input 1

# -----------------------------------------------------------------------------
# Reset Interface
# -----------------------------------------------------------------------------
add_interface reset reset end
set_interface_property reset associatedClock clk
set_interface_property reset synchronousEdges DEASSERT
set_interface_property reset ENABLED true
set_interface_property reset EXPORT_OF ""
set_interface_property reset PORT_NAME_MAP ""
set_interface_property reset CMSIS_SVD_VARIABLES ""
set_interface_property reset SVD_ADDRESS_GROUP ""

add_interface_port reset rst reset Input 1

# -----------------------------------------------------------------------------
# Slave Interface
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Bus Interfaces (Generic)
# -----------------------------------------------------------------------------
{% for iface in expanded_bus_interfaces %}
{% if iface.type == 'AXI4L' %}
{% set intel_type = 'axi4lite' %}
{% elif iface.type == 'AVALON_MM' %}
{% set intel_type = 'avalon' %}
{% elif iface.type == 'AXIS' %}
{% set intel_type = 'axi4stream' %}
{% elif iface.type == 'AVALON_ST' %}
{% set intel_type = 'avalon_streaming' %}
{% else %}
{% set intel_type = 'unknown' %}
{% endif %}
{% set end_type = 'end' if iface.mode in ['slave', 'sink'] else 'start' %}

# Interface: {{ iface.name }} ({{ iface.type }})
add_interface {{ iface.name }} {{ intel_type }} {{ end_type }}
set_interface_property {{ iface.name }} associatedClock clk
set_interface_property {{ iface.name }} associatedReset reset
set_interface_property {{ iface.name }} ENABLED true
set_interface_property {{ iface.name }} EXPORT_OF ""
set_interface_property {{ iface.name }} PORT_NAME_MAP ""
set_interface_property {{ iface.name }} CMSIS_SVD_VARIABLES ""
set_interface_property {{ iface.name }} SVD_ADDRESS_GROUP ""

# Type-specific properties
{% if intel_type == 'axi4lite' %}
set_interface_property {{ iface.name }} readAcceptanceCapability 1
set_interface_property {{ iface.name }} writeAcceptanceCapability 1
{% elif intel_type == 'avalon' %}
set_interface_property {{ iface.name }} addressUnits WORDS
set_interface_property {{ iface.name }} maximumPendingReadTransactions 1
{% endif %}

# Ports
{% for port in iface.ports %}
add_interface_port {{ iface.name }} {{ port.name }} {{ port.logical_name | lower }} {{ 'Input' if port.direction == 'in'
else 'Output' }} {{ port.width }}
{% endfor %}

{% endfor %}

{% if user_ports %}
# -----------------------------------------------------------------------------
# Conduit Interface (User Ports)
# -----------------------------------------------------------------------------
add_interface conduit conduit end
set_interface_property conduit associatedClock clk
set_interface_property conduit associatedReset reset
set_interface_property conduit ENABLED true
set_interface_property conduit EXPORT_OF ""
set_interface_property conduit PORT_NAME_MAP ""
set_interface_property conduit CMSIS_SVD_VARIABLES ""
set_interface_property conduit SVD_ADDRESS_GROUP ""

{% for port in user_ports %}
add_interface_port conduit {{ port.name }} {{ port.name }} {{ 'Output' if port.direction == 'out' else 'Input' }} {% if
port.is_parameterized %}{{ port.width_expr }}{% else %}{{ port.width | default(1) }}{% endif %}

{% endfor %}
{% endif %}
}

# -----------------------------------------------------------------------------
# Module Properties
# -----------------------------------------------------------------------------
set_module_property DESCRIPTION "{{ description | default('IP core with register interface') }}"
set_module_property NAME {{ entity_name }}
set_module_property VERSION {{ version | default('1.0') }}
set_module_property INTERNAL false
set_module_property OPAQUE_ADDRESS_MAP true
set_module_property AUTHOR "{{ author | default('ipcore_lib') }}"
set_module_property DISPLAY_NAME "{{ display_name | default(entity_name | replace('_', ' ') | title) }}"
set_module_property INSTANTIATE_IN_SYSTEM_MODULE true
set_module_property EDITABLE true
set_module_property REPORT_TO_TALKBACK false
set_module_property ALLOW_GREYBOX_GENERATION false
set_module_property REPORT_HIERARCHY false
set_module_property VALIDATION_CALLBACK validate
set_module_property ELABORATION_CALLBACK elaborate

# -----------------------------------------------------------------------------
# File Sets
# -----------------------------------------------------------------------------
add_fileset QUARTUS_SYNTH QUARTUS_SYNTH "" ""
set_fileset_property QUARTUS_SYNTH TOP_LEVEL {{ entity_name }}
set_fileset_property QUARTUS_SYNTH ENABLE_RELATIVE_INCLUDE_PATHS false
set_fileset_property QUARTUS_SYNTH ENABLE_FILE_OVERWRITE_MODE false
add_fileset_file {{ entity_name }}_pkg.vhd VHDL PATH ../rtl/{{ entity_name }}_pkg.vhd
add_fileset_file {{ entity_name }}_regs.vhd VHDL PATH ../rtl/{{ entity_name }}_regs.vhd
add_fileset_file {{ entity_name }}_core.vhd VHDL PATH ../rtl/{{ entity_name }}_core.vhd
add_fileset_file {{ entity_name }}_{{ bus_type }}.vhd VHDL PATH ../rtl/{{ entity_name }}_{{ bus_type }}.vhd
add_fileset_file {{ entity_name }}.vhd VHDL PATH ../rtl/{{ entity_name }}.vhd TOP_LEVEL_FILE

add_fileset SIM_VHDL SIM_VHDL "" ""
set_fileset_property SIM_VHDL TOP_LEVEL {{ entity_name }}
set_fileset_property SIM_VHDL ENABLE_RELATIVE_INCLUDE_PATHS false
set_fileset_property SIM_VHDL ENABLE_FILE_OVERWRITE_MODE false
add_fileset_file {{ entity_name }}_pkg.vhd VHDL PATH ../rtl/{{ entity_name }}_pkg.vhd
add_fileset_file {{ entity_name }}_regs.vhd VHDL PATH ../rtl/{{ entity_name }}_regs.vhd
add_fileset_file {{ entity_name }}_core.vhd VHDL PATH ../rtl/{{ entity_name }}_core.vhd
add_fileset_file {{ entity_name }}_{{ bus_type }}.vhd VHDL PATH ../rtl/{{ entity_name }}_{{ bus_type }}.vhd
add_fileset_file {{ entity_name }}.vhd VHDL PATH ../rtl/{{ entity_name }}.vhd TOP_LEVEL_FILE

# -----------------------------------------------------------------------------
# Parameters
# -----------------------------------------------------------------------------
{% for generic in generics %}
add_parameter {{ generic.name | upper }} {{ generic.type | upper }} {{ generic.default_value }}
set_parameter_property {{ generic.name | upper }} DEFAULT_VALUE {{ generic.default_value }}
set_parameter_property {{ generic.name | upper }} DISPLAY_NAME "{{ generic.name | replace('_', ' ') | title }}"
set_parameter_property {{ generic.name | upper }} TYPE {{ generic.type | upper }}
set_parameter_property {{ generic.name | upper }} UNITS None
set_parameter_property {{ generic.name | upper }} HDL_PARAMETER true
set_parameter_property {{ generic.name | upper }} AFFECTS_GENERATION false
set_parameter_property {{ generic.name | upper }} AFFECTS_ELABORATION true

{% endfor %}
